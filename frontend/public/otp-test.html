<!DOCTYPE html>
<html>
<head>
    <title>OTP Verification Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5568d3;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .result {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>ðŸ”§ OTP Verification Diagnostic Tool</h1>
    <p>This tool helps diagnose OTP verification issues.</p>

    <!-- Test 1: Check Backend Connection -->
    <div class="test-section">
        <h3>Test 1: Backend Connection</h3>
        <button onclick="testBackend()">Check Backend Health</button>
        <div id="backend-result" class="result"></div>
    </div>

    <!-- Test 2: Register Test User -->
    <div class="test-section">
        <h3>Test 2: Register Test User</h3>
        <input type="email" id="reg-email" placeholder="test@example.com" value="testuser@example.com">
        <input type="text" id="reg-username" placeholder="username" value="testuser123">
        <input type="text" id="reg-name" placeholder="Full Name" value="Test User">
        <input type="password" id="reg-password" placeholder="password" value="Test@1234">
        <button onclick="testRegister()">Register User</button>
        <div id="register-result" class="result"></div>
    </div>

    <!-- Test 3: Verify OTP -->
    <div class="test-section">
        <h3>Test 3: Verify OTP</h3>
        <input type="email" id="verify-email" placeholder="email" value="testuser@example.com">
        <input type="text" id="verify-otp" placeholder="6-digit OTP" maxlength="6">
        <button onclick="testVerifyOTP()">Verify OTP</button>
        <div id="verify-result" class="result"></div>
    </div>

    <!-- Test 4: Check LocalStorage -->
    <div class="test-section">
        <h3>Test 4: Check Storage</h3>
        <button onclick="checkStorage()">Check LocalStorage</button>
        <button onclick="clearStorage()">Clear Storage</button>
        <div id="storage-result" class="result"></div>
    </div>

    <!-- Test 5: Resend OTP -->
    <div class="test-section">
        <h3>Test 5: Resend OTP</h3>
        <input type="email" id="resend-email" placeholder="email" value="testuser@example.com">
        <button onclick="testResendOTP()">Resend OTP</button>
        <div id="resend-result" class="result"></div>
    </div>

    <script>
        const API = 'http://localhost:5000';

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = message;
            console.log(message);
        }

        async function testBackend() {
            log('backend-result', 'Testing backend connection...', 'info');
            try {
                const res = await fetch(`${API}/health`);
                const data = await res.json();
                log('backend-result', 
                    `âœ… Backend is running!\n\n` +
                    `Status: ${data.status}\n` +
                    `MongoDB: ${data.mongodb}\n` +
                    `Email: ${data.email}\n` +
                    `Port: ${data.port}\n` +
                    `Uptime: ${data.uptime}s`, 
                    'success'
                );
            } catch (err) {
                log('backend-result', 
                    `âŒ Backend connection failed!\n\n` +
                    `Error: ${err.message}\n` +
                    `Make sure backend is running on port 5000`, 
                    'error'
                );
            }
        }

        async function testRegister() {
            const email = document.getElementById('reg-email').value;
            const username = document.getElementById('reg-username').value;
            const name = document.getElementById('reg-name').value;
            const password = document.getElementById('reg-password').value;

            log('register-result', 'Registering user...', 'info');
            
            try {
                const res = await fetch(`${API}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, username, name, password })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    localStorage.setItem('pendingVerificationEmail', email);
                    log('register-result', 
                        `âœ… Registration successful!\n\n` +
                        `${data.msg}\n` +
                        `Email: ${email}\n\n` +
                        `âš ï¸ Check your email for the OTP code!\n` +
                        `(If using Gmail, check spam folder)\n\n` +
                        `Email stored in localStorage.`, 
                        'success'
                    );
                } else {
                    log('register-result', 
                        `âŒ Registration failed!\n\n` +
                        `${data.msg}`, 
                        'error'
                    );
                }
            } catch (err) {
                log('register-result', 
                    `âŒ Registration error!\n\n` +
                    `${err.message}`, 
                    'error'
                );
            }
        }

        async function testVerifyOTP() {
            const email = document.getElementById('verify-email').value;
            const otp = document.getElementById('verify-otp').value;

            if (otp.length !== 6) {
                log('verify-result', 'âŒ OTP must be 6 digits!', 'error');
                return;
            }

            log('verify-result', `Verifying OTP for ${email}...`, 'info');
            
            try {
                const res = await fetch(`${API}/api/auth/verify-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, otp })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    log('verify-result', 
                        `âœ… Verification successful!\n\n` +
                        `${data.msg}\n` +
                        `Email: ${email}\n\n` +
                        `You can now login!`, 
                        'success'
                    );
                } else {
                    log('verify-result', 
                        `âŒ Verification failed!\n\n` +
                        `Status: ${res.status}\n` +
                        `Message: ${data.msg}\n` +
                        `Attempts Remaining: ${data.attemptsRemaining || 'N/A'}`, 
                        'error'
                    );
                }
            } catch (err) {
                log('verify-result', 
                    `âŒ Verification error!\n\n` +
                    `${err.message}`, 
                    'error'
                );
            }
        }

        function checkStorage() {
            const email = localStorage.getItem('pendingVerificationEmail');
            const expiry = localStorage.getItem('otpExpiry');
            const allKeys = Object.keys(localStorage);
            
            log('storage-result', 
                `ðŸ“¦ LocalStorage Contents:\n\n` +
                `pendingVerificationEmail: ${email || 'NOT SET'}\n` +
                `otpExpiry: ${expiry || 'NOT SET'}\n\n` +
                `All keys: ${allKeys.join(', ') || 'Empty'}\n\n` +
                `Total items: ${allKeys.length}`, 
                email ? 'success' : 'error'
            );
        }

        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            log('storage-result', 'ðŸ§¹ Storage cleared!', 'info');
        }

        async function testResendOTP() {
            const email = document.getElementById('resend-email').value;

            log('resend-result', `Resending OTP to ${email}...`, 'info');
            
            try {
                const res = await fetch(`${API}/api/auth/resend-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    log('resend-result', 
                        `âœ… OTP resent!\n\n` +
                        `${data.msg}\n` +
                        `Check your email for new code.`, 
                        'success'
                    );
                } else {
                    log('resend-result', 
                        `âŒ Resend failed!\n\n` +
                        `${data.msg}`, 
                        'error'
                    );
                }
            } catch (err) {
                log('resend-result', 
                    `âŒ Resend error!\n\n` +
                    `${err.message}`, 
                    'error'
                );
            }
        }

        // Auto-run backend test on load
        window.onload = () => {
            testBackend();
            checkStorage();
        };
    </script>
</body>
</html>
